<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Jur√≠dica - Laurte Lessa</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #fcfcfc; --vinho: #4a0e0e; --dourado: #b8935a; --borda: #e1e1e1; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .topo-acoes { display: flex; gap: 15px; margin-bottom: 25px; }
        .btn-premium { border: 1px solid var(--dourado); border-radius: 4px; padding: 10px 25px; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; transition: 0.3s; }
        .btn-reagendar { background: var(--vinho); color: white; }
        .btn-produtividade { background: white; color: var(--dourado); }
        .header-box { background: white; padding: 30px; border-radius: 4px; border: 1px solid var(--borda); width: 100%; max-width: 950px; margin-bottom: 30px; display: flex; flex-direction: column; align-items: center; border-top: 5px solid var(--dourado); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .logo-img { max-width: 280px; height: auto; margin-bottom: 20px; }
        .mic-btn { width: 65px; height: 65px; border-radius: 50%; border: 1px solid var(--dourado); background: white; color: var(--dourado); font-size: 25px; cursor: pointer; }
        .header-flex { display: flex; width: 100%; justify-content: space-around; align-items: center; flex-wrap: wrap; }
        .chart-box { width: 140px; height: 140px; }
        .dashboard { display: flex; gap: 20px; width: 100%; max-width: 1450px; overflow-x: auto; padding: 10px; }
        .coluna { background: white; border: 1px solid var(--borda); border-radius: 4px; padding: 20px; min-width: 280px; flex: 1; }
        .coluna h2 { font-family: 'Cinzel', serif; font-size: 0.9rem; color: var(--dourado); text-align: center; border-bottom: 1px solid var(--borda); padding-bottom: 15px; }
        .card-tarefa { background: #fafafa; padding: 15px; border-radius: 2px; margin-bottom: 15px; border-left: 3px solid var(--dourado); box-shadow: 2px 2px 5px rgba(0,0,0,0.02); }
        #calendar { background: white; padding: 20px; border-radius: 4px; border: 1px solid var(--borda); width: 100%; max-width: 1450px; margin-top: 30px; }
        .btn-card { border: none; padding: 6px 12px; border-radius: 2px; cursor: pointer; margin-top: 10px; font-size: 0.7rem; text-transform: uppercase; }
    </style>
</head>
<body>
    <div class="topo-acoes">
        <button class="btn-premium btn-reagendar" onclick="reagendarOntem()">Reagendar Pend√™ncias</button>
        <button class="btn-premium btn-produtividade" onclick="window.location.reload(true)">Atualizar Dados</button>
    </div>
    <div class="header-box">
        <img src="logo.png" alt="Logo" class="logo-img">
        <div class="header-flex">
            <div style="text-align: center; min-width: 250px;">
                <p style="font-family: 'Cinzel', serif; font-size: 0.9rem; color: var(--dourado); letter-spacing: 2px;">PAINEL DE <span id="nome-usuario">...</span></p>
                <button id="meu-mic" class="mic-btn">üé§</button>
                <p id="status-texto" style="font-size: 0.7rem; color: #888;">SISTEMA PRONTO</p>
                <button onclick="mudarSenha()" style="background:none; border:none; color:var(--dourado); cursor:pointer; font-size: 0.65rem;">üîê Mudar Senha</button> | 
                <button onclick="logout()" style="background:none; border:none; color:#999; cursor:pointer; font-size: 0.65rem;">Sair</button>
            </div>
            <div class="chart-box"><canvas id="graficoProdutividade"></canvas></div>
        </div>
    </div>
    <div class="dashboard">
        <div class="coluna"><h2>üì¢ Audi√™ncias</h2><div id="lista-audiencia"></div></div>
        <div class="coluna"><h2>üìÖ Para Hoje</h2><div id="lista-hoje"></div></div>
        <div class="coluna"><h2>‚è≥ Agendados</h2><div id="lista-agendado"></div></div>
        <div class="coluna"><h2>üß† Hist√≥rico</h2><div id="lista-historico"></div></div>
    </div>
    <div id="calendar"></div>
    <script>
    const API_URL = 'https://gestao-juridica-9r72.onrender.com';
    const usuarioId = localStorage.getItem('usuario_id');
    const usuarioNome = localStorage.getItem('usuario_nome');
    let chartObj, calendar;

    if (!usuarioId) { window.location.href = 'login.html'; }
    else { document.getElementById('nome-usuario').innerText = usuarioNome.toUpperCase(); }

    function atualizarGrafico(ok, p) {
        const ctx = document.getElementById('graficoProdutividade').getContext('2d');
        if (chartObj) chartObj.destroy();
        chartObj = new Chart(ctx, { type: 'doughnut', data: { labels: ['OK', 'Pendente'], datasets: [{ data: [ok, p], backgroundColor: ['#b8935a', '#f0f0f0'], borderWidth: 0 }] }, options: { cutout: '80%', plugins: { legend: { display: false } } } });
    }

    async function carregarTudo() {
        try {
            const res = await fetch(`${API_URL}/api/lista-tarefas/${usuarioId}`);
            const tarefas = await res.json();
            const ok = tarefas.filter(t => t.status === 'CONCLU√çDA').length;
            atualizarGrafico(ok, tarefas.length - ok);
            const listas = { audiencia: document.getElementById('lista-audiencia'), hoje: document.getElementById('lista-hoje'), agendado: document.getElementById('lista-agendado'), historico: document.getElementById('lista-historico') };
            Object.values(listas).forEach(l => l.innerHTML = "");
            const hojeStr = new Date().toLocaleDateString('en-CA');
            const eventos = [];
            tarefas.forEach(t => {
                const isC = t.status === 'CONCLU√çDA', dataT = t.criado_em.split('T')[0];
                const card = `<div class="card-tarefa"><strong>${t.titulo.toUpperCase()}</strong><br><small style="color:var(--dourado)">${dataT.split('-').reverse().join('/')}</small><br>${!isC ? `<button class="btn-card" style="background:var(--dourado);color:white" onclick="concluir(${t.id})">OK</button>` : ''} <button class="btn-card" style="background:#eee" onclick="excluir(${t.id})">X</button></div>`;
                if (isC) listas.historico.innerHTML += card;
                else if (t.titulo.toLowerCase().includes('audi√™ncia')) listas.audiencia.innerHTML += card;
                else if (dataT === hojeStr) listas.hoje.innerHTML += card;
                else listas.agendado.innerHTML += card;
                eventos.push({ title: t.titulo, start: dataT, color: isC ? '#28a745' : '#b8935a' });
            });
            calendar.removeAllEvents(); calendar.addEventSource(eventos);
        } catch (e) { console.error(e); }
    }

    const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    rec.lang = 'pt-BR';
    document.getElementById('meu-mic').onclick = () => { rec.start(); document.getElementById('status-texto').innerText = "OUVINDO..."; };
    rec.onresult = async (e) => {
        const texto = e.results[0][0].transcript;
        const res = await fetch(`${API_URL}/api/salvar-tarefa`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ texto, usuario_id: usuarioId }) });
        if (res.ok) { document.getElementById('status-texto').innerText = "‚úÖ REGISTRADO"; carregarTudo(); }
    };

    async function mudarSenha() {
        const novaSenha = prompt("Nova senha (min 4 caracteres):");
        if (novaSenha && novaSenha.length >= 4) {
            const res = await fetch(`${API_URL}/api/alterar-senha`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ usuario_id: usuarioId, novaSenha }) });
            if (res.ok) alert("Senha alterada!");
        }
    }

    async function reagendarOntem() { await fetch(`${API_URL}/api/reagendar-ontem/${usuarioId}`, { method: 'PUT' }); carregarTudo(); }
    async function concluir(id) { await fetch(`${API_URL}/api/concluir-tarefa/${id}`, { method: 'PUT' }); carregarTudo(); }
    async function excluir(id) { if(confirm("Remover?")) { await fetch(`${API_URL}/api/excluir-tarefa/${id}`, { method: 'DELETE' }); carregarTudo(); } }
    function logout() { localStorage.clear(); window.location.href = 'login.html'; }

    document.addEventListener('DOMContentLoaded', () => {
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), { initialView: 'dayGridMonth', locale: 'pt-br', height: 'auto' });
        calendar.render(); carregarTudo();
    });
    </script>
</body>
</html>