<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Gest√£o - Laurte Lessa & Marcos Pedro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg-escritorio: #fcfcfc; 
            --vinho-escuro: #4a0e0e; 
            --dourado: #b8935a;      
            --cinza-texto: #333333;
            --borda: #e1e1e1;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-escritorio); 
            color: var(--cinza-texto);
            margin: 0; padding: 20px; 
            display: flex; flex-direction: column; align-items: center; 
        }

        /* TOPO PROFISSIONAL */
        .topo-acoes { display: flex; gap: 15px; margin-bottom: 25px; }
        .btn-premium { 
            border: 1px solid var(--dourado); border-radius: 4px; padding: 10px 25px; 
            font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            transition: 0.3s; font-size: 0.75rem;
        }
        .btn-reagendar { background: var(--vinho-escuro); color: white; }
        .btn-produtividade { background: white; color: var(--dourado); }

        .header-box { 
            background: white; 
            padding: 30px; border-radius: 4px; 
            border: 1px solid var(--borda);
            width: 100%; max-width: 950px; 
            margin-bottom: 30px;
            display: flex; flex-direction: column; align-items: center;
            border-top: 5px solid var(--dourado);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .logo-img {
            max-width: 280px;
            height: auto;
            margin-bottom: 20px;
            display: block;
        }

        .mic-btn { 
            width: 65px; height: 65px; border-radius: 50%; border: 1px solid var(--dourado); 
            background: white; color: var(--dourado); font-size: 25px; 
            cursor: pointer; transition: 0.3s; margin: 10px 0;
        }
        .mic-btn:hover { background: var(--dourado); color: white; }

        .header-flex {
            display: flex;
            width: 100%;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }

        .chart-box { width: 140px; height: 140px; }

        /* DASHBOARD */
        .dashboard { display: flex; gap: 20px; width: 100%; max-width: 1450px; overflow-x: auto; padding: 10px; }
        .coluna { 
            background: white; border: 1px solid var(--borda); border-radius: 4px; padding: 20px; 
            min-width: 300px; flex: 1;
        }
        .coluna h2 { 
            font-family: 'Cinzel', serif; font-size: 0.9rem; color: var(--dourado); 
            margin-top: 0; text-align: center; border-bottom: 1px solid var(--borda);
            padding-bottom: 15px; margin-bottom: 20px;
        }

        .card-tarefa { 
            background: #fafafa; padding: 15px; border-radius: 2px; 
            margin-bottom: 15px; border-left: 3px solid var(--dourado);
            box-shadow: 2px 2px 5px rgba(0,0,0,0.02); text-align: left;
        }

        #calendar { 
            background: white; padding: 30px; border-radius: 4px; border: 1px solid var(--borda);
            width: 100%; max-width: 1450px; margin-top: 30px;
        }

        .btn-card { border: none; padding: 6px 12px; border-radius: 2px; cursor: pointer; margin-top: 10px; font-size: 0.7rem; text-transform: uppercase; }
    </style>
</head>
<body>

    <div class="topo-acoes">
        <button class="btn-premium btn-reagendar" onclick="reagendarOntem()">Reagendar Pend√™ncias</button>
        <button class="btn-premium btn-produtividade" onclick="location.reload()">Atualizar Dashboard</button>
    </div>

    <div class="header-box">
        <img src="logo.png" alt="Laurte Lessa Advogados" class="logo-img">
        
        <div class="header-flex">
            <div style="text-align: center; min-width: 250px;">
                <p style="font-family: 'Cinzel', serif; font-size: 0.9rem; color: var(--dourado); margin: 0; letter-spacing: 2px;">
                    PAINEL DE <span id="nome-usuario">CARREGANDO...</span>
                </p>
                <button id="meu-mic" class="mic-btn">üé§</button>
                <p id="status-texto" style="font-size: 0.7rem; color: #888; margin: 0;">SISTEMA DE VOZ ATIVO</p>
                <button onclick="logout()" style="background:none; border:none; color:#999; cursor:pointer; font-size: 0.7rem; margin-top: 10px;">Encerrar Sess√£o</button>
            </div>

            <div class="chart-box">
                <canvas id="graficoProdutividade"></canvas>
            </div>
        </div>
    </div>

    <div class="dashboard">
        <div class="coluna"><h2>üì¢ Audi√™ncias</h2><div id="lista-audiencia"></div></div>
        <div class="coluna"><h2>üìÖ Para Hoje</h2><div id="lista-hoje"></div></div>
        <div class="coluna"><h2>‚è≥ Agendados</h2><div id="lista-agendado"></div></div>
        <div class="coluna"><h2>üß† Hist√≥rico</h2><div id="lista-historico"></div></div>
    </div>

    <div id="calendar"></div>

    <script>
    const API_URL = 'https://gestao-juridica-9r72.onrender.com';
    const usuarioId = localStorage.getItem('usuario_id');
    const usuarioNome = localStorage.getItem('usuario_nome');
    let chartObj;
    let calendar;

    if (!usuarioId) { window.location.href = 'login.html'; }
    else { document.getElementById('nome-usuario').innerText = usuarioNome.toUpperCase(); }

    function atualizarGrafico(concluidas, pendentes) {
        const ctx = document.getElementById('graficoProdutividade').getContext('2d');
        if (chartObj) chartObj.destroy();
        chartObj = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['OK', 'Pendente'],
                datasets: [{
                    data: [concluidas, pendentes],
                    backgroundColor: ['#b8935a', '#f0f0f0'],
                    borderWidth: 0
                }]
            },
            options: { cutout: '80%', plugins: { legend: { display: false } } }
        });
    }

    async function carregarTudo() {
        const res = await fetch(`${API_URL}/api/lista-tarefas/${usuarioId}`);
        const tarefas = await res.json();
        
        const okCount = tarefas.filter(t => t.status === 'CONCLU√çDA').length;
        const pCount = tarefas.length - okCount;
        atualizarGrafico(okCount, pCount);

        const listas = {
            audiencia: document.getElementById('lista-audiencia'),
            hoje: document.getElementById('lista-hoje'),
            agendado: document.getElementById('lista-agendado'),
            historico: document.getElementById('lista-historico')
        };
        Object.values(listas).forEach(l => l.innerHTML = "");
        
        const hojeStr = new Date().toISOString().split('T')[0];
        const eventosParaCalendario = [];

        tarefas.forEach(t => {
            const isConcluida = t.status === 'CONCLU√çDA';
            const dataTarefa = t.criado_em.split('T')[0];

            const card = `<div class="card-tarefa">
                <strong>${t.titulo.toUpperCase()}</strong><br>
                <small style="color:var(--dourado); font-weight:bold;">${dataTarefa.split('-').reverse().join('/')}</small>
                <div style="margin-top:10px;">
                    ${!isConcluida ? `<button class="btn-card" style="background:#b8935a; color:white" onclick="concluir(${t.id})">Concluir</button>` : ''}
                    <button class="btn-card" style="background:#eee; color:#666" onclick="excluir(${t.id})">Remover</button>
                </div>
            </div>`;

            if (isConcluida) listas.historico.innerHTML += card;
            else if (t.titulo.toLowerCase().includes('audi√™ncia')) listas.audiencia.innerHTML += card;
            else if (dataTarefa === hojeStr) listas.hoje.innerHTML += card;
            else listas.agendado.innerHTML += card;

            eventosParaCalendario.push({
                title: t.titulo,
                start: dataTarefa,
                color: isConcluida ? '#28a745' : '#b8935a'
            });
        });

        calendar.removeAllEvents();
        calendar.addEventSource(eventosParaCalendario);
    }

    const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const rec = new Recognition(); rec.lang = 'pt-BR';
    document.getElementById('meu-mic').onclick = () => { rec.start(); document.getElementById('status-texto').innerText = "OUVINDO..."; };
    rec.onresult = async (e) => {
        const texto = e.results[0][0].transcript;
        await fetch(`${API_URL}/api/salvar-tarefa`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ texto, usuario_id: usuarioId })
        });
        carregarTudo();
        document.getElementById('status-texto').innerText = "REGISTRADO";
    };

    async function reagendarOntem() {
        if(confirm("Sincronizar tarefas pendentes para hoje?")) {
            await fetch(`${API_URL}/api/reagendar-ontem/${usuarioId}`, { method: 'PUT' });
            carregarTudo();
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), { 
            initialView: 'dayGridMonth',
            locale: 'pt-br',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,dayGridWeek' }
        });
        calendar.render();
        carregarTudo();
    });

    async function concluir(id) { await fetch(`${API_URL}/api/concluir-tarefa/${id}`, { method: 'PUT' }); carregarTudo(); }
    async function excluir(id) { if(confirm("Remover?")) { await fetch(`${API_URL}/api/excluir-tarefa/${id}`, { method: 'DELETE' }); carregarTudo(); } }
    function logout() { localStorage.clear(); window.location.href = 'login.html'; }
    </script>
</body>
</html>