<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel Executive - Marcos Pedro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    
    <style>
        :root { 
            --bg-dark: #0f172a; 
            --card-dark: #1e293b; 
            --text-main: #f8fafc;
            --accent: #38bdf8;
            --success: #22c55e;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg-dark); 
            color: var(--text-main);
            margin: 0; padding: 20px; 
            display: flex; flex-direction: column; align-items: center; 
        }

        /* BOT√ïES SUPERIORES */
        .topo-acoes { display: flex; gap: 15px; margin-bottom: 25px; }
        .btn-reagendar { background: #ea580c; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-produtividade { background: #0891b2; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        .header-pro { 
            background: var(--card-dark); 
            padding: 30px; border-radius: 24px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            width: 100%; max-width: 900px; 
            margin-bottom: 30px;
            display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap;
        }

        .mic-section { text-align: center; flex: 1; }
        .chart-section { width: 180px; height: 180px; flex: 0 0 180px; }

        .mic-btn { 
            width: 80px; height: 80px; border-radius: 50%; border: none; 
            background: var(--accent); color: white; font-size: 30px; 
            cursor: pointer; box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
        }

        /* COLUNAS */
        .dashboard { display: flex; gap: 20px; width: 100%; max-width: 1400px; overflow-x: auto; padding-bottom: 20px; }
        .coluna { 
            background: var(--card-dark); 
            border-radius: 20px; padding: 20px; 
            min-width: 300px; flex: 1;
            border-top: 4px solid var(--accent);
        }
        .coluna h2 { font-size: 1.2rem; color: var(--accent); margin-top: 0; }

        .card-tarefa { 
            background: #334155; 
            padding: 16px; border-radius: 12px; 
            margin-bottom: 12px; border-left: 4px solid var(--accent);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #calendar { 
            background: var(--card-dark); color: white;
            padding: 25px; border-radius: 24px; 
            width: 100%; max-width: 1400px; margin-top: 30px;
        }

        .btn-card { border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="topo-acoes">
        <button class="btn-reagendar" onclick="reagendarOntem()">üîÑ Reagendar Ontem</button>
        <button class="btn-produtividade" onclick="window.scrollTo(0,0)">üìä Dashboard Real-Time</button>
    </div>

    <div class="header-pro">
        <div class="mic-section">
            <h1 id="boas-vindas" style="margin-top:0">üéôÔ∏è Ol√°!</h1>
            <button id="meu-mic" class="mic-btn">üé§</button>
            <p id="status-texto" style="color: var(--accent)">Sistema Pronto</p>
            <button onclick="logout()" style="color:#94a3b8; background:none; border:none; cursor:pointer;">Encerrar Sess√£o</button>
        </div>

        <div class="chart-section">
            <canvas id="graficoProdutividade"></canvas>
        </div>
    </div>

    <div class="dashboard">
        <div class="coluna"><h2>üì¢ Audi√™ncias</h2><div id="lista-audiencia"></div></div>
        <div class="coluna"><h2>üìÖ Para Hoje</h2><div id="lista-hoje"></div></div>
        <div class="coluna"><h2>‚è≥ Agendados</h2><div id="lista-agendado"></div></div>
        <div class="coluna"><h2>üß† Hist√≥rico</h2><div id="lista-historico"></div></div>
    </div>

    <div id="calendar"></div>

    <script>
    const API_URL = 'https://gestao-juridica-9r72.onrender.com';
    const usuarioId = localStorage.getItem('usuario_id');
    const usuarioNome = localStorage.getItem('usuario_nome');
    let chartProd;

    if (!usuarioId) { window.location.href = 'login.html'; }
    else { document.getElementById('boas-vindas').innerText = `Painel de ${usuarioNome}`; }

    // Inicializa o Gr√°fico
    function inicializarGrafico(concluidas, pendentes) {
        const ctx = document.getElementById('graficoProdutividade').getContext('2d');
        if (chartProd) chartProd.destroy();
        chartProd = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Conclu√≠das', 'Pendentes'],
                datasets: [{
                    data: [concluidas, pendentes],
                    backgroundColor: ['#22c55e', '#334155'],
                    borderWidth: 0
                }]
            },
            options: { cutout: '70%', plugins: { legend: { display: false } } }
        });
    }

    async function carregarTudo() {
        const res = await fetch(`${API_URL}/api/lista-tarefas/${usuarioId}`);
        const tarefas = await res.json();
        
        // Dados para o Gr√°fico
        const concluidas = tarefas.filter(t => t.status === 'CONCLU√çDA').length;
        const pendentes = tarefas.length - concluidas;
        inicializarGrafico(concluidas, pendentes);

        const listas = {
            audiencia: document.getElementById('lista-audiencia'),
            hoje: document.getElementById('lista-hoje'),
            agendado: document.getElementById('lista-agendado'),
            historico: document.getElementById('lista-historico')
        };
        Object.values(listas).forEach(l => l.innerHTML = "");
        const hoje = new Date().toISOString().split('T')[0];
        const eventos = [];

        tarefas.forEach(t => {
            const isConcluida = t.status === 'CONCLU√çDA';
            const dataT = t.criado_em.split('T')[0];
            const card = `<div class="card-tarefa">
                <strong>${t.titulo}</strong><br>
                <small style="color:var(--accent)">${dataT.split('-').reverse().join('/')}</small>
                <div style="margin-top:10px;">
                    ${!isConcluida ? `<button class="btn-card" style="background:var(--success); color:white" onclick="concluirTarefa(${t.id})">Concluir</button>` : ''}
                    <button class="btn-card" style="background:#ef4444; color:white" onclick="excluirTarefa(${t.id})">Excluir</button>
                </div>
            </div>`;

            if (isConcluida) listas.historico.innerHTML += card;
            else if (t.titulo.toLowerCase().includes('audi√™ncia')) listas.audiencia.innerHTML += card;
            else if (dataT === hoje) listas.hoje.innerHTML += card;
            else listas.agendado.innerHTML += card;

            eventos.push({ title: t.titulo, start: dataT });
        });
        calendar.removeAllEvents(); calendar.addEventSource(eventos);
    }

    // Reconhecimento de Voz
    const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new Recognition();
    recognition.lang = 'pt-BR';
    document.getElementById('meu-mic').onclick = () => { recognition.start(); document.getElementById('status-texto').innerText = "Ouvindo Voz..."; };
    recognition.onresult = async (e) => {
        const texto = e.results[0][0].transcript;
        await fetch(`${API_URL}/api/salvar-tarefa`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ texto, usuario_id: usuarioId })
        });
        carregarTudo();
        document.getElementById('status-texto').innerText = "‚úÖ Tarefa Registrada!";
    };

    async function reagendarOntem() {
        if(confirm("Sincronizar tarefas pendentes de ontem para hoje?")) {
            await fetch(`${API_URL}/api/reagendar-ontem/${usuarioId}`, { method: 'PUT' });
            carregarTudo();
        }
    }

    let calendar;
    document.addEventListener('DOMContentLoaded', () => {
        calendar = new FullCalendar.Calendar(document.getElementById('calendar'), { initialView: 'dayGridMonth', themeSystem: 'standard' });
        calendar.render();
        carregarTudo();
    });

    async function concluirTarefa(id) { await fetch(`${API_URL}/api/concluir-tarefa/${id}`, { method: 'PUT' }); carregarTudo(); }
    async function excluirTarefa(id) { if(confirm("Excluir?")) { await fetch(`${API_URL}/api/excluir-tarefa/${id}`, { method: 'DELETE' }); carregarTudo(); } }
    function logout() { localStorage.clear(); window.location.href = 'login.html'; }
    </script>
</body>
</html>